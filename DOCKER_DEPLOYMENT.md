# Docker Deployment Guide

This guide explains how to deploy the Rent Management application using Docker.

## Prerequisites

- Docker Engine 20.10+
- Docker Compose 2.0+
- At least 2GB of available RAM
- At least 5GB of available disk space

## Quick Start

### 1. Clone the Repository

```bash
git clone https://github.com/lugmanahmed/Rent-Managment.git
cd Rent-Managment
```

### 2. Set Environment Variables

```bash
# Copy the Docker environment example file
cp .env.docker.example .env

# Edit .env with your production values
nano .env  # or use your preferred editor
```

**Important:** Make sure to set the following:
- `APP_KEY` - Generate with `php artisan key:generate`
- `DB_PASSWORD` - Strong database password
- `DB_ROOT_PASSWORD` - MySQL root password
- `APP_URL` - Your production domain URL
- `NEXT_PUBLIC_API_URL` - Your API URL (should match APP_URL/api)
- `SANCTUM_STATEFUL_DOMAINS` - Comma-separated list of your domains

### 3. Build and Start Containers

```bash
# Build all images
docker-compose build

# Start all services
docker-compose up -d

# View logs
docker-compose logs -f
```

### 4. Initialize Database

```bash
# Run migrations
docker-compose exec backend php artisan migrate

# (Optional) Seed the database
docker-compose exec backend php artisan db:seed
```

### 5. Access the Application

- **Frontend**: http://localhost (or your configured domain)
- **Backend API**: http://localhost/api
- **Health Check**: http://localhost/health

## Container Architecture

The application consists of the following containers:

### 1. MySQL Database
- **Image**: `mysql:8.0`
- **Port**: `3306` (default)
- **Data Persistence**: Volume `mysql_data`

### 2. Laravel Backend (PHP-FPM)
- **Port**: `9000` (internal)
- **Storage**: Persistent volumes for storage and cache
- **Features**:
  - Automatic database migrations on startup
  - Configuration caching
  - Route caching
  - View caching

### 3. Next.js Frontend
- **Port**: `3000` (internal)
- **Build**: Multi-stage build for optimized production bundle

### 4. Nginx Web Server
- **HTTP Port**: `80` (configurable via `NGINX_HTTP_PORT`)
- **HTTPS Port**: `443` (configurable via `NGINX_HTTPS_PORT`)
- **Features**:
  - Reverse proxy for frontend and backend
  - Gzip compression
  - Static file caching
  - Security headers

## Environment Variables

### Required Variables

| Variable | Description | Example |
|----------|-------------|---------|
| `APP_KEY` | Laravel encryption key | Generated by artisan |
| `DB_DATABASE` | Database name | `rent_management` |
| `DB_PASSWORD` | Database user password | `secure_password` |
| `DB_ROOT_PASSWORD` | MySQL root password | `root_password` |
| `APP_URL` | Application URL | `https://yourdomain.com` |
| `NEXT_PUBLIC_API_URL` | API URL for frontend | `https://yourdomain.com/api` |
| `SANCTUM_STATEFUL_DOMAINS` | Allowed domains for auth | `yourdomain.com,www.yourdomain.com` |

### Optional Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `APP_ENV` | Environment | `production` |
| `APP_DEBUG` | Debug mode | `false` |
| `NGINX_HTTP_PORT` | HTTP port | `80` |
| `NGINX_HTTPS_PORT` | HTTPS port | `443` |
| `DB_PORT` | Database port | `3306` |

## Docker Commands

### Start Services
```bash
docker-compose up -d
```

### Stop Services
```bash
docker-compose stop
```

### View Logs
```bash
# All services
docker-compose logs -f

# Specific service
docker-compose logs -f backend
docker-compose logs -f frontend
docker-compose logs -f nginx
docker-compose logs -f mysql
```

### Execute Commands
```bash
# Run artisan commands
docker-compose exec backend php artisan migrate
docker-compose exec backend php artisan cache:clear

# Access backend shell
docker-compose exec backend sh

# Access MySQL
docker-compose exec mysql mysql -u root -p
```

### Rebuild After Code Changes
```bash
# Rebuild and restart
docker-compose up -d --build

# Rebuild specific service
docker-compose up -d --build backend
```

## Health Checks

All services include health checks:

- **Backend**: `GET /api/health`
- **Frontend**: `GET /health`
- **Nginx**: `GET /health`

Check container health:
```bash
docker-compose ps
```

## Production Deployment

### 1. SSL/HTTPS Setup

For production, you should set up SSL certificates. Options:

**Option A: Let's Encrypt with Certbot**
```bash
# Add certbot service to docker-compose.yml
# Configure nginx to use SSL certificates
```

**Option B: Reverse Proxy (Recommended)**
Deploy behind a reverse proxy like:
- Cloudflare
- AWS Application Load Balancer
- Traefik
- Caddy

### 2. Backup Strategy

```bash
# Backup database
docker-compose exec mysql mysqldump -u root -p rent_management > backup.sql

# Backup storage
docker-compose exec backend tar czf /tmp/storage-backup.tar.gz storage/
docker cp rent-management-backend:/tmp/storage-backup.tar.gz ./
```

### 3. Monitoring

Consider adding monitoring services:
- **Prometheus** for metrics
- **Grafana** for visualization
- **Sentry** for error tracking

### 4. Resource Limits

Update `docker-compose.yml` to set resource limits:

```yaml
services:
  backend:
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
```

## Troubleshooting

### Database Connection Issues

```bash
# Check database is running
docker-compose ps mysql

# Test connection
docker-compose exec backend php artisan tinker
>>> DB::connection()->getPdo();
```

### Frontend Not Loading

```bash
# Check frontend logs
docker-compose logs frontend

# Verify environment variable
docker-compose exec frontend env | grep NEXT_PUBLIC_API_URL
```

### Permission Issues

```bash
# Fix storage permissions
docker-compose exec backend chown -R www-data:www-data storage bootstrap/cache
docker-compose exec backend chmod -R 775 storage bootstrap/cache
```

### Clear All Caches

```bash
docker-compose exec backend php artisan config:clear
docker-compose exec backend php artisan route:clear
docker-compose exec backend php artisan view:clear
docker-compose exec backend php artisan cache:clear
```

## Updating the Application

```bash
# Pull latest code
git pull

# Rebuild containers
docker-compose build

# Restart services
docker-compose up -d

# Run migrations if needed
docker-compose exec backend php artisan migrate
```

## Clean Up

```bash
# Stop and remove containers
docker-compose down

# Remove volumes (WARNING: Deletes data)
docker-compose down -v

# Remove images
docker-compose down --rmi all
```

## Support

For issues and questions:
1. Check logs: `docker-compose logs`
2. Verify environment variables
3. Check container health: `docker-compose ps`
4. Review this documentation

## Security Notes

1. **Never commit `.env` file** - It contains sensitive information
2. **Use strong passwords** - Especially for database
3. **Enable HTTPS** - For production deployments
4. **Keep images updated** - Regularly update base images
5. **Set resource limits** - Prevent resource exhaustion
6. **Use secrets management** - For production (Docker Secrets, Vault, etc.)

